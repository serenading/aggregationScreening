clear
close all

%% Script reads in featuresTable and plots stacked bar graphs for blob category and food region statistics to show comprising fractions of tracking indices.
% Author: @serenading. July 2020

%% Specify which dataset
wormNum = 40;
extractStamp = '20200519_153722';

%% load
[featureTable,pathname] = loadLatestFeatureTable(extractStamp,wormNum);
uniqueStrains = unique(featureTable.strain_name);

%% pre-allocate
% worm category
wormFractionsMean = NaN(numel(uniqueStrains),4);
wormFractionsStd = NaN(numel(uniqueStrains),4);
% all worms food region
foodRegionFractionsMean = NaN(numel(uniqueStrains),3);
foodRegionFractionsStd = NaN(numel(uniqueStrains),3);
% lone worms food region
swFoodRegionFractionsMean = NaN(numel(uniqueStrains),3);
% paused multiworm food region
pausedMwFoodRegionFractionsMean = NaN(numel(uniqueStrains),3);
% cluster food region
clusterFoodRegionFractionsMean = NaN(numel(uniqueStrains),3);
% phase 1 food region
phase1FoodRegionFractionsMean = NaN(numel(uniqueStrains),3);
% not phase 1 food region
notPhase1FoodRegionFractionsMean = NaN(numel(uniqueStrains),3);
% phase 1 worm category
phase1WormFractionsMean = NaN(numel(uniqueStrains),4);
% not phase 1 worm category
notPhase1WormFractionsMean = NaN(numel(uniqueStrains),4);

%% go through each strain to get worm fractions and food region fractions

% each strain
for strainCtr = 1:numel(uniqueStrains)
    strain = uniqueStrains(strainCtr);
    strainLogInd = strcmp(featureTable.strain_name,strain);
    
    % worm category
    wormFractions = [featureTable.swFraction(strainLogInd),featureTable.pausedMwFraction(strainLogInd),featureTable.clusterFraction(strainLogInd),featureTable.tempBlobFraction(strainLogInd)];
    wormFractionsMean(strainCtr,:) = mean(wormFractions,1);
    wormFractionsSE(strainCtr,:) = std(wormFractions)/sqrt(nnz(strainLogInd));
    
    % all worms food region
    foodRegionFractions = [featureTable.food_region_inside_fraction(strainLogInd),featureTable.food_region_edge_fraction(strainLogInd),featureTable.food_region_outside_fraction(strainLogInd)];
    foodRegionFractionsMean(strainCtr,:) = mean(foodRegionFractions,1);
    foodRegionFractionsSE(strainCtr,:) = std(foodRegionFractions)/sqrt(nnz(strainLogInd));
    
    % single worm food region 
    swFoodRegionFractions = [featureTable.sw_onFood_fraction(strainLogInd),featureTable.sw_foodEdge_fraction(strainLogInd),featureTable.sw_offFood_fraction(strainLogInd)]...
        ./featureTable.swFraction(strainLogInd);
    swFoodRegionFractionsMean(strainCtr,:) = mean(swFoodRegionFractions,1);
    
    % paused multiworm food region
    pausedMwFoodRegionFractions = [featureTable.pausedMw_onFood_fraction(strainLogInd),featureTable.pausedMw_foodEdge_fraction(strainLogInd),featureTable.pausedMw_offFood_fraction(strainLogInd)]...
        ./featureTable.pausedMwFraction(strainLogInd);
    pausedMwFoodRegionFractionsMean(strainCtr,:) = mean(pausedMwFoodRegionFractions,1);
    
    % cluster food region
    clusterFoodRegionFractions = [featureTable.cluster_onFood_fraction(strainLogInd),featureTable.cluster_foodEdge_fraction(strainLogInd),featureTable.cluster_offFood_fraction(strainLogInd)]...
        ./featureTable.clusterFraction(strainLogInd);
    clusterFoodRegionFractionsMean(strainCtr,:) = mean(clusterFoodRegionFractions,1);
    
    % phase 1 food region
    phase1FoodRegionFractions = [featureTable.onFood_phase1_fraction(strainLogInd),featureTable.foodEdge_phase1_fraction(strainLogInd),featureTable.offFood_phase1_fraction(strainLogInd)]...
        /(1/3);
    phase1FoodRegionFractionsMean(strainCtr,:) = mean(phase1FoodRegionFractions,1);
    
    % not phase 1 food rgion
    notPhase1FoodRegionFractions = [featureTable.onFood_notPhase1_fraction(strainLogInd),featureTable.foodEdge_notPhase1_fraction(strainLogInd),featureTable.offFood_phase1_fraction(strainLogInd)]...
        /(2/3);
    
    % 
    
end

%% stacked bar plots to show proportions

% worm category
figure;bar(wormFractionsMean,'stacked')
% hold on;errorbar(cumsum(wormFractionsMean')',wormFractionsSE,'.k');
xticks(1:numel(uniqueStrains))
xticklabels(uniqueStrains)
xtickangle(90)
ylabel(['fraction of tracking indices for ' num2str(wormNum) ' worms'],'FontSize',15)
legend({'single worm','paused multiworm','cluster','temp'},'FontSize',15,'Location','northeastoutside')
title('tracking indices by worm category','FontSize',15)

% all worms food region
figure;bar(foodRegionFractionsMean,'stacked')
% hold on;errorbar(cumsum(foodRegionFractionsMean')',foodRegionFractionsSE,'.k');
xticks(1:numel(uniqueStrains))
xticklabels(uniqueStrains)
xtickangle(90)
ylim([0 1])
ylabel(['fraction of tracking indices for ' num2str(wormNum) ' worms'],'FontSize',15)
legend({'onFood','foodEdge','offFood'},'FontSize',15,'Location','northeastoutside')
title('tracking indices by food region','FontSize',15)

% single worms food region
figure;bar(swFoodRegionFractionsMean,'stacked')
xticks(1:numel(uniqueStrains))
xticklabels(uniqueStrains)
xtickangle(90)
ylim([0 1])
ylabel(['fraction of tracking indices for ' num2str(wormNum) ' worms'],'FontSize',15)
legend({'onFood','foodEdge','offFood'},'FontSize',15,'Location','northeastoutside')
title('single worm tracking indices by food region','FontSize',15)

% paused multiworms food region
figure;bar(pausedMwFoodRegionFractionsMean,'stacked')
xticks(1:numel(uniqueStrains))
xticklabels(uniqueStrains)
xtickangle(90)
ylim([0 1])
ylabel(['fraction of tracking indices for ' num2str(wormNum) ' worms'],'FontSize',15)
legend({'onFood','foodEdge','offFood'},'FontSize',15,'Location','northeastoutside')
title('paused multiworm tracking indices by food region','FontSize',15)

% cluster food region
figure;bar(clusterFoodRegionFractionsMean,'stacked')
xticks(1:numel(uniqueStrains))
xticklabels(uniqueStrains)
xtickangle(90)
ylim([0 1])
ylabel(['fraction of tracking indices for ' num2str(wormNum) ' worms'],'FontSize',15)
legend({'onFood','foodEdge','offFood'},'FontSize',15,'Location','northeastoutside')
title('cluster tracking indices by food region','FontSize',15)